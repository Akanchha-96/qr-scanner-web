<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>QR Scanner Validation</title>

<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gradient-to-br from-indigo-600 to-purple-700 min-h-screen flex items-center justify-center p-4">

<div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-lg text-center">

    <h1 class="text-3xl font-bold text-purple-700 mb-4">
        The Endless Journey - Entry Validation
    </h1>

    <p class="text-gray-600 mb-6">
        Scan Guest QR to validate entrance
    </p>

    <div id="reader" class="mb-6 border rounded-lg overflow-hidden"></div>

    <div id="result" class="text-xl font-semibold"></div>

</div>

<script>
const CSV_URL =
 "https://raw.githubusercontent.com/Akanchha-96/qr-scanner-web/refs/heads/main/guests.csv";

let guestList = {};
let scanned = new Set();

// ---------------- FETCH CSV --------------------
fetch(CSV_URL)
.then(res => res.text())
.then(csvData => {
    let lines = csvData.split('\n');

    for(let i=1; i < lines.length; i++){
        let row = lines[i].trim();
        if(!row) continue;

        let parts = row.split(',');
        let name = parts[0];
        let role = parts[1];
        let id   = parts[2];

        guestList[id] = {name, role};
    }

    startScanner();
});

// --------------- QR Scanner ---------------------
function startScanner(){

    function onScanSuccess(qr){
        let result = validate(qr);
        document.getElementById("result").innerHTML = result;
    }

    let scanner = new Html5QrcodeScanner(
        "reader", 
        { fps: 10, qrbox: 250 }
    );

    scanner.render(onScanSuccess);
}

// ---------------- VALIDATION --------------------
function validate(text){

    let id = extractID(text);

    if(!id) return "Invalid QR format";

    if(!guestList[id]) return "Guest Not Found ❌";

    if(scanned.has(id)) return "Already Scanned ⛔";

    scanned.add(id);
    return "Allowed ✔";
}

// ------------ EXTRACT ID -----------------------
function extractID(text){
    let lines = text.split('\n');
    for(let line of lines){
        if(line.startsWith("ID:")){
            return line.split("ID:")[1].trim();
        }
    }
    return null;
}
</script>

</body>
</html>
