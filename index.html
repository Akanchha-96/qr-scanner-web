<!DOCTYPE html>
<html>
<head>
<title>QR Scanner Validation</title>

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body{
    font-family: arial;
    text-align: center;
}
#result{
    font-size:24px;
    margin-top:20px;
    font-weight:bold;
}
</style>
</head>

<body>

<h2>QR Scanner Validation</h2>

<div id="reader" style="width:300px;margin:auto;"></div>

<div id="result"></div>

<script>
const CSV_URL =
 "https://raw.githubusercontent.com/Akanchha-96/qr-scanner-web/refs/heads/main/guests.csv";

let guestList = {};
let scanned = new Set();

// ---------------- FETCH CSV --------------------
fetch(CSV_URL)
.then(res => res.text())
.then(csvData => {
    let lines = csvData.split('\n');

    for(let i=1; i < lines.length; i++){
        let row = lines[i].trim();
        if(!row) continue;

        let parts = row.split(',');
        let name = parts[0];
        let role = parts[1];
        let id   = parts[2];

        guestList[id] = {name, role};
    }

    startScanner();
});

// --------------- QR Scanner ---------------------
function startScanner(){

    function onScanSuccess(qr){
        let result = validate(qr);
        document.getElementById("result").innerHTML = result;
    }

    let scanner = new Html5QrcodeScanner(
        "reader", 
        { fps: 10, qrbox: 250 }
    );

    scanner.render(onScanSuccess);
}

// ---------------- VALIDATION --------------------
function validate(text){

    let id = extractID(text);

    if(!id) return "Invalid QR format";

    if(!guestList[id]) return "Guest Not Found ❌";

    if(scanned.has(id)) return "Already Scanned ⛔";

    scanned.add(id);
    return "Allowed ✔";
}

// ------------ EXTRACT ID -----------------------
function extractID(text){
    let lines = text.split('\n');
    for(let line of lines){
        if(line.startsWith("ID:")){
            return line.split("ID:")[1].trim();
        }
    }
    return null;
}
</script>

</body>
</html>
