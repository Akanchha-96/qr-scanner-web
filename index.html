<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>QR Scanner Validation</title>

<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
/* Fade animation */
.fade-in {
    animation: fadeIn 0.4s ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: scale(0.9); }
    to { opacity: 1; transform: scale(1); }
}
</style>

</head>

<body class="bg-gradient-to-br from-indigo-600 to-purple-700 min-h-screen flex items-center justify-center p-4">

<div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-lg text-center">

    <h1 class="text-3xl font-bold text-purple-700 mb-4">
        The Endless Journey - Entry Validation
    </h1>

    <p class="text-gray-600 mb-6">
        Scan Guest QR to validate entrance
    </p>

    <div id="reader" class="mb-6 border rounded-lg overflow-hidden"></div>

    <div id="result" class="text-xl font-semibold"></div>

</div>

<!-- ALERT POPUP -->
<div id="alertBox" class="hidden fixed top-0 left-0 w-full h-full 
    bg-black/50 flex items-center justify-center p-4">
    <div id="alertContent" class="bg-white rounded-xl p-6 text-center shadow-2xl fade-in">
        <h2 id="alertMessage" class="text-2xl font-bold mb-4"></h2>
        <button onclick="closeAlert()"
            class="bg-purple-600 text-white px-6 py-2 rounded-lg shadow">
            OK
        </button>
    </div>
</div>

<script>
const CSV_URL =
 "https://raw.githubusercontent.com/Akanchha-96/qr-scanner-web/refs/heads/main/guests.csv";

let guestList = {};
let scanned = new Set();

// ---------------- FETCH CSV --------------------
fetch(CSV_URL)
.then(res => res.text())
.then(csvData => {
    let lines = csvData.split('\n');

    for(let i=1; i < lines.length; i++){
        let row = lines[i].trim();
        if(!row) continue;

        let parts = row.split(',');
        let name = parts[0];
        let role = parts[1];
        let id   = parts[2];

        guestList[id] = {name, role};
    }

    startScanner();
});

// --------------- ALERT POPUP ---------------------
function showAlert(message, color="text-black") {
    let alertBox = document.getElementById("alertBox");
    let alertMsg = document.getElementById("alertMessage");

    alertMsg.innerText = message;
    alertMsg.className = "text-2xl font-bold mb-4 " + color;

    alertBox.classList.remove("hidden");
}

function closeAlert() {
    document.getElementById("alertBox").classList.add("hidden");
}

// --------------- QR SCANNER ---------------------
function startScanner(){

    function onScanSuccess(qr){
        validate(qr);
    }

    let scanner = new Html5QrcodeScanner(
        "reader", 
        { fps: 10, qrbox: 250 }
    );

    scanner.render(onScanSuccess);
}

// ---------------- VALIDATION --------------------
function validate(text){

    let id = extractID(text);

    if(!id){
        showAlert("❗ Invalid QR format", "text-red-600");
        return;
    }

    if(!guestList[id]){
        showAlert("❌ Guest Not Found", "text-red-600");
        return;
    }

    if(scanned.has(id)){
        showAlert("⛔ Already Scanned", "text-orange-600");
        return;
    }

    scanned.add(id);
    showAlert("✔ Allowed", "text-green-600");
}

// ------------ EXTRACT ID -----------------------
function extractID(text){
    let lines = text.split('\n');
    for(let line of lines){
        if(line.startsWith("ID:")){
            return line.split("ID:")[1].trim();
        }
    }
    return null;
}
</script>

</body>
</html>
