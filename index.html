<!DOCTYPE html>
<html>
<head>
<title>QR Scanner</title>

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body {
  font-family: Arial;
  text-align: center;
}
#reader {
  width: 350px;
  margin: auto;
}
#result {
  padding: 15px;
  font-size: 22px;
}
</style>
</head>

<body>
<h2>Guest QR Verification</h2>

<input type="file" id="csvFile" accept=".csv">
<br><br>

<div id="reader"></div>
<div id="result"></div>

<script>
let guestList = {};
let scanned = new Set();

document.getElementById('csvFile').addEventListener('change', function(e){
    let file = e.target.files[0];
    let reader = new FileReader();

    reader.onload = function(){
        let lines = reader.result.split('\n');

        // skip header
        for(let i=1; i < lines.length; i++){
            let row = lines[i].trim();
            if(row){
                let parts = row.split(',');
                let name = parts[0];
                let role = parts[1];
                let id   = parts[2];

                guestList[id] = {name, role};
            }
        }

        alert("CSV loaded successfully!");
    };

    reader.readAsText(file);
});


function processQR(qr){
    let id = null;

    qr.split('\n').forEach(line=>{
        if (line.startsWith("ID:")) {
            id = line.split("ID:")[1].trim();
        }
    });

    if(!id){
        return "Invalid QR Code format!";
    }

    // check exist
    if(!guestList[id]) return "Permission Denied: Guest Not Found!";

    // check scanned
    if(scanned.has(id)) return "Already Scanned!";

    scanned.add(id);
    let g = guestList[id];
    return "Permission Granted âœ“<br>" + g.name + " ("+g.role+")";
}


function onScanSuccess(decodedText){
    let msg = processQR(decodedText);
    document.getElementById("result").innerHTML = msg;
}


let html5QrCode = new Html5Qrcode("reader");
html5QrCode.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    onScanSuccess
);
</script>
</body>
</html>
